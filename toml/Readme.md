# Gitlab Kubernetes Runner Setup

## Introduction
This repository will provides you step by step guides to register your kubernetes cluster as Gitlab Runner Executor.
Some assumption used in here:
1. Kubernetes cluster have 2 worker nodes - you can modify it as you like
2. Using Minio as local S3 cache for the Gitlab Runner
3. All sensitive values are masked with environment variables. Make sure you change it before run the script
4. Script made to be run in Unix environment.

## Environment variables

| Name | Description | Example |
|------|-------------|---------|
|TLS_CA_FILE| (Optional) Set this value if you want to register to self-hosted Gitlab that use self-signed certificates| `/etc/gitlab-runner/certs/<your-gitlab-domain-cert>.crt` |
|BASE_CICD_URL| URL of your Gitlab | `https://gitlab.domain.co.id` |
|BASE_CICD_URL_WITHOUT_HTTP| URL of your Gitlab without http/https| `cicd-gitlab.telkomsel.co.id` |
|KUBERNETES_GITLAB_RUNNER_TOKEN| When you registering your nodes for the first time, you will obtain this token on the toml output file generated by the command `gitlab-runner register` | `0ba70138e4a813c29d8d5e6cc3d74f`
|REGISTRATION_TOKEN|Token that appears on the project `Settings > CI CD` | `1ThKnH_vFt3pLzdeg8yf`

## Shell scripts explanation

| Name | Description |
|------|-------------|
|00a-register-gitlab-ssl.sh | (Optional) run this to add self-signed certificate as trusted certificate required when later running `gitlab-runner register` command |
|00b-register-k8s-runner.sh | Register your kubernetes cluster to your Gitlab|
|01-create-runner-namespace.sh| Create Gitlab Runner in isolated namespace `gitlab-runner`|
|02-create-runner-cache.sh| Provision and setup Minio as Gitlab runner cache (you can use S3 or other provider also)|
|03-create-runner-svcaccount.sh | Create specific service account for Gitlab Runner|
|04-create-runner-config-map.sh| Store Kubernetes Gitlab Runner setting and configuration as Kubernetes ConfigMap |
|05-create-runner-deployment.sh| Provision and setup Gitlab Runner in your kubernetes cluster. It will create `deployment` and one `pod`|
